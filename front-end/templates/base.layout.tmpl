{{define "base"}}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NYC Capital Projects AI Agent</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
   <link href="/static/css/styles.css" rel="stylesheet" />
</head>

<body>
  <div class="container py-4">
    <h1 class="text-center mb-4">NYC Capital Projects AI Agent</h1>

    <div id="chat-container"></div>

    <div id="input-area">
      <textarea id="question" class="form-control" rows="2" placeholder="Type your question..."></textarea>
      <button id="submit" class="btn btn-primary">Send</button>
    </div>

    <div class="text-center text-muted">
      âš¡ Note: Since the AI agent runs locally, responses may take a few seconds.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const chatContainer = document.getElementById('chat-container');
    const questionInput = document.getElementById('question');
    const submitButton = document.getElementById('submit');

    function addMessage(text, type, timestamp = null) {
      const row = document.createElement('div');
      row.className = `chat-row ${type === 'user-message' ? 'user' : ''}`;

      const avatar = document.createElement('div');
      avatar.className = `avatar ${type === 'user-message' ? 'user-avatar' : 'ai-avatar'}`;
      avatar.innerHTML = type === 'user-message'
        ? '<i class="fas fa-user"></i>'
        : '<i class="fas fa-robot"></i>';

      const msg = document.createElement('div');
      msg.className = `message ${type}`;

      const content = document.createElement('div');
      content.className = 'content';
      content.innerHTML = text;

      const ts = document.createElement('div');
      ts.className = 'timestamp';
      ts.innerText = timestamp || new Date().toLocaleTimeString();

      msg.appendChild(content);
      msg.appendChild(ts);

      if (type === 'user-message') {
        row.appendChild(msg);
        row.appendChild(avatar);
      } else {
        row.appendChild(avatar);
        row.appendChild(msg);
      }

      chatContainer.appendChild(row);
      chatContainer.scrollTop = chatContainer.scrollHeight; // scroll to latest
      return content; // returns the content div for updating
    }

    async function sendQuestion() {
      const question = questionInput.value.trim();
      if (!question) return;

      // Disable input while waiting
      questionInput.disabled = true;
      submitButton.disabled = true;

      addMessage(question, 'user-message');
      questionInput.value = '';

      const thinkingContent = addMessage(
        'AI is typing... <span class="spinner-border spinner-border-sm"></span>',
        'ai-message'
      );

      try {
        const res = await fetch('http://localhost:4000/answer-user-question', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question })
        });

        if (!res.ok) throw new Error(`HTTP ${res.status}`);

        const json = await res.json();

        let answer = 'No answer returned.';
        if (!json.error && json.data?.answer) {
          answer = json.data.answer;
        } else if (json.message) {
          answer = json.message;
        }

        // Clear spinner
        thinkingContent.innerHTML = '';

        // Smooth typing animation
        let i = 0;
        const typeWriter = () => {
          if (i <= answer.length) {
            thinkingContent.innerText = answer.slice(0, i);
            chatContainer.scrollTop = chatContainer.scrollHeight; // keep scrolling
            i++;
            requestAnimationFrame(typeWriter);
          }
        };
        requestAnimationFrame(typeWriter);

      } catch (err) {
        thinkingContent.innerText = 'Error: ' + err.message;
      } finally {
        // Re-enable input after response
        questionInput.disabled = false;
        submitButton.disabled = false;
        questionInput.focus();
      }
    }

    submitButton.onclick = sendQuestion;

    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (!questionInput.disabled) sendQuestion();
      }
    });

    window.onload = () => {
      addMessage(
        "Hi! Iâ€™m your NYC Capital Projects AI Agent ðŸ¤–. Ask me about any NYC capital projects!",
        'ai-message'
      );
    };
  </script>
</body>
</html>

{{end}}
